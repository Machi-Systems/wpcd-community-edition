#!/bin/bash

# set temporary environment vars.
# This first one should be set to the 
WPCD_USER=ubuntu

# Output the environment vars in the parameters file.
if [[ -e /$WPCD_USER/stablediff-script-params.sh ]]; then
    source /$WPCD_USER/stablediff-script-params.sh
fi

# Switch folders
cd /home/$WPCD_USER/stable-diffusion

echo "Contents of stable-diffusion folder..."
ls

# conda does not work inside bash scripts.
# see https://github.com/conda/conda/issues/7980
# this is the workaround.
source /home/$WPCD_USER/miniconda3/etc/profile.d/conda.sh

# Set python environment
echo "Activating Conda Environment 'ldm'"
conda activate ldm

# Warm up the server
echo "Warming up server with first image request...this will take a very very long time!"
python scripts/txt2img.py --prompt "Blue Tesla Car on Dark Background" --plms --ckpt sd-v1-4.ckpt --skip_grid --n_samples 1 

# show output as finished.
echo
echo "Finished!"
echo
