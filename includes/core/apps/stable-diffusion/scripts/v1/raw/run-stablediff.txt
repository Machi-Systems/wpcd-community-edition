#!/bin/bash

# set temporary environment vars.
# This first one should be set to the 
WPCD_USER=ubuntu

# Output the environment vars in the parameters file.
if [[ -e /$WPCD_USER/stablediff-script-params.sh ]]; then
    source /$WPCD_USER/stablediff-script-params.sh
fi

# Switch folders
cd /home/$WPCD_USER/stable-diffusion

echo "Contents of stable-diffusion folder..."
ls

# conda does not work inside bash scripts.
# see https://github.com/conda/conda/issues/7980
# this is the workaround.
source /home/$WPCD_USER/miniconda3/etc/profile.d/conda.sh

# Set python environment
echo "Activating Conda Environment 'ldm'"
conda activate ldm

# runs stable diffusion.  Environment variables should already be set because the params.sh file was already run.
echo "Running stable diffusion with requested parameters!"
python scripts/txt2img.py --prompt "$AI_PROMPT" --plms --ckpt sd-v1-4.ckpt --skip_grid --n_samples $AI_SAMPLES --outdir $AI_OUTPUT_DIR --ddim_steps $AI_STEPS --H $AI_HEIGHT --W $AI_WIDTH --seed $AI_SEED

# Let WPCD know that we're done.
if [[ -n "$CALLBACK_URL_SUCCESS" ]]
then
	curl -sS "$CALLBACK_URL_SUCCESS?done=1"
fi

# show output as finished.
echo
echo "Finished!"
echo
