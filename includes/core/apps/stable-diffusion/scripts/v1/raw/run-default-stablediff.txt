#!/bin/bash

# set temporary environment vars.
if [[ -n "$WPCD_USER" ]]
then
	echo "WPCD USER environment var not set, using default of 'ubuntu'..."
	WPCD_USER=ubuntu
fi

# Switch folders
cd /home/$WPCD_USER/stable-diffusion

echo "Contents of stable-diffusion folder..."
ls

# conda does not work inside bash scripts.
# see https://github.com/conda/conda/issues/7980
# this is the workaround.
source /home/$WPCD_USER/miniconda3/etc/profile.d/conda.sh

# Set python environment
echo "Activating Conda Environment 'ldm'"
conda activate ldm

# runs stable diffusion.  Environment variables should already be set because the bootstrap script should have already set the environment vars.
echo "Running stable diffusion with requested parameters!"
python scripts/txt2img.py --prompt "$AI_PROMPT" --plms --ckpt sd-v1-4.ckpt --skip_grid --n_samples $AI_SAMPLES --outdir $AI_OUTPUT_DIR --ddim_steps $AI_STEPS --H $AI_HEIGHT --W $AI_WIDTH --seed $AI_SEED

# Upload files to aws s3.
echo $(date): "Uploading files to S3..."
if [[ -n "$AWS_BUCKET" ]]
then
	aws s3 cp /home/$WPCD_USER/stable-diffusion/$AI_OUTPUT_DIR s3://$AWS_BUCKET/$AWS_FOLDER --recursive
fi

# Let WPCD know that we're done.
if [[ -n "$CALLBACK_URL" ]]
then
	curl -sS "$CALLBACK_URL?state=done&taskid=$TASK_ID"
fi

# show output as finished.
echo
echo "Finished!"
echo
